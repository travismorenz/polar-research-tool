<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}"/>

    <!-- Scripts -->
    <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script>
    <script src="{{ url_for('static', filename='jquery-1.8.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='d3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='as-common.js') }}"></script>

    <!-- MathJax -->
    <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script>

    <!-- Google Analytics JS -->
    <script>
      (function(i, s, o, g, r, a, m) {i["GoogleAnalyticsObject"] = r;
      (i[r] = i[r] || function() { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 * new Date());
      (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
      a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })
      (window, document, "script", "https://www.google-analytics.com/analytics.js", "ga");
      ga("create", "UA-3698471-25", "auto"); ga("send", "pageview");
    </script>

    <script>

      // passed in from flask as json
      var tweets = {{ tweets | tojson }};
      var papers = {{ papers | tojson }};
      var pid_to_users = {{ pid_to_users | tojson }};
      var msg = "{{ msg }}";
      var render_format = "{{ render_format }}";
      var username = "{{ g.user.username }}";
      var numresults = "{{ numresults }}";
      var show_prompt = "{{ show_prompt }}";

      var urlq = ''; // global will be read in to QueryString when load is done

      // when page loads...
      $(document).ready(function(){

        urlq = QueryString.q;

        // display message, if any
        if(msg !== '') { d3.select("#rtable").append('div').classed('msg', true).html(msg); }

        // add papers to #rtable
        var done = addPapers(10, false);
        if(done) { $("#loadmorebtn").hide(); }

        // set up inifinite scrolling for adding more papers
        $(window).on('scroll', function(){
          var scrollTop = $(document).scrollTop();
          var windowHeight = $(window).height();
          var bodyHeight = $(document).height() - windowHeight;
          var scrollPercentage = (scrollTop / bodyHeight);
          if(scrollPercentage > 0.9) {
            var done = addPapers(5, true);
            if(done) { $("#loadmorebtn").hide(); }
          }
        });

        // just in case scrolling is broken somehow, provide a button handler explicit
        $("#loadmorebtn").on('click', function(){
          var done = addPapers(5, true);
          if(done) { $("#loadmorebtn").hide(); }
        });

        if(papers.length === 0) { $("#loadmorebtn").hide(); }

        if(!(typeof urlq == 'undefined')) {
          d3.select("#qfield").attr('value', urlq.replace(/\+/g, " "));
        }

        var vf = QueryString.vfilter; if(typeof vf === 'undefined') { vf = 'all'; }
        var tf = QueryString.timefilter; if(typeof tf === 'undefined') { tf = 'week'; }
        var link_endpoint = '/';
        if(render_format === 'recent') { link_endpoint = ''; }
        if(render_format === 'top') { link_endpoint = 'top'; }
        if(render_format === 'recommend') { link_endpoint = 'recommend'; }
        if(render_format === 'friends') { link_endpoint = 'friends'; }
        if(render_format === 'toptwtr') { link_endpoint = 'toptwtr'; }
        if(render_format === 'discussions') { link_endpoint = 'discussions'; }
        if(render_format === 'analytics') { link_endpoint = 'analytics'; }
        if(render_format === 'topics') { link_endpoint = 'topics'; }
        if(render_format === 'keyphrase') { link_endpoint = 'keyphrase'; }
        if(render_format === 'rankings') { link_endpoint = 'rankings'; }
        if(render_format === 'graph') { link_endpoint = 'graph'; }
        if(render_format === 'venues') { link_endpoint = 'venues'; }


        var time_ranges = ['day', '3days', 'week', 'month', 'year', 'alltime'];
        var time_txt = {'day':'Last day', '3days': 'Last 3 days', 'week': 'Last week', 'month': 'Last month', 'year': 'Last year', 'alltime': 'All time'}
        var time_range = tf;

        // set up time filtering options
        if(render_format === 'recommend' || render_format === 'top' || render_format === 'recent' || render_format === 'friends') {
          // insert version filtering options for these views
          var elt = d3.select('#recommend-time-choice');
          var vflink = vf === 'all' ? '1' : 'all'; // toggle only showing v1 or not
          if(render_format === 'recent') {
            var aelt = elt.append('a').attr('href', '/'+link_endpoint+'?'+'&vfilter='+vflink); // leave out timefilter from this page
          } else {
            var aelt = elt.append('a').attr('href', '/'+link_endpoint+'?'+'timefilter='+time_range+'&vfilter='+vflink);
          }
          var delt = aelt.append('div').classed('vchoice', true).html('Only show v1');
          if(vf === '1') { delt.classed('vchoice-selected', true); }
        }

        // time choices for recommend/top
        if(render_format === 'recommend' || render_format === 'top' || render_format === 'friends') {
          // insert time filtering options for these two views
          var elt = d3.select('#recommend-time-choice');
          elt.append('div').classed('fdivider', true).html('|');
          for(var i=0;i<time_ranges.length;i++) {
            var time_range = time_ranges[i];
            var aelt = elt.append('a').attr('href', '/'+link_endpoint+'?'+'timefilter='+time_range+'&vfilter='+vf);
            var delt = aelt.append('div').classed('timechoice', true).html(time_txt[time_range]);
            if(tf == time_range) { delt.classed('timechoice-selected', true); } // also render as chosen
          }
        }

        // time choices for top tweets
        if(render_format === 'toptwtr') {
          var tf = QueryString.timefilter; if(typeof tf === 'undefined') { tf = 'day'; } // default here is day
          var time_ranges = ['day', 'week', 'month'];
          var elt = d3.select('#recommend-time-choice');
          for(var i=0;i<time_ranges.length;i++) {
            var time_range = time_ranges[i];
            var aelt = elt.append('a').attr('href', '/'+link_endpoint+'?'+'timefilter='+time_range);
            var delt = aelt.append('div').classed('timechoice', true).html(time_txt[time_range]);
            if(tf == time_range) { delt.classed('timechoice-selected', true); } // also render as chosen
          }
        }

        var xb = $("#xbanner");
        if(xb.length !== 0) {
          xb.click(function(){ $("#banner").slideUp('fast'); })
        }

        // in top tab: color current choice
        if( render_format === 'recent') { d3.select('#tabrecent').classed('tab-selected', true); }
        if( render_format === 'top') { d3.select('#tabtop').classed('tab-selected', true); }
        if( render_format === 'toptwtr') { d3.select('#tabtwtr').classed('tab-selected', true); }
        if( render_format === 'friends') { d3.select('#tabfriends').classed('tab-selected', true); }
        if( render_format === 'discussions') { d3.select('#tabdiscussions').classed('tab-selected', true); }
        if( render_format === 'recommend') { d3.select('#tabrec').classed('tab-selected', true); }
        if( render_format === 'library') { d3.select('#tablib').classed('tab-selected', true);}
        if( render_format === 'analytics') { d3.select('#tabanalyze').classed('tab-selected', true); }
        if( render_format === 'topics') { d3.select('#tabtopic').classed('tab-selected', true); }
        if( render_format === 'keyphrase') { d3.select('#tabkeyphrase').classed('tab-selected', true); }
        if( render_format === 'venues') { d3.select('#tabvenues').classed('tab-selected', true); }
        if( render_format === 'graph') { d3.select('#tabgraph').classed('tab-selected', true); }
        if( render_format === 'rankings') { d3.select('#tabrankings').classed('tab-selected', true); }
        if( render_format === 'keyphrase') { d3.select('#tabkeyphrase').classed('tab-selected', true); }



        $("#goaway").on('click', function(){
          $("#prompt").slideUp('fast');
          $.post("/goaway", {}).done(function(data){ });
        });
      });
    </script>

    <title>{% block title %}{% endblock %} - POLAR</title>
  </head>
  <body>
    <header class="navbar container grid-xl">
      <section class="navbar-section">
        <a href="{{ url_for('intmain') }}" class="navbar-brand mr-10">POLAR Research Tool</a>
      </section>
      <section class="navbar-section">
        {% if current_user.is_authenticated %}
        <div class="dropdown">
          <a href="#" class="btn dropdown-toggle" tabindex="0">
            {{current_user.username}} &#9660;
          </a>
          <ul class="menu">
            <li class="menu-item">
              <a href="{{url_for('logout')}}">
                Logout
              </a>
            </li>
          </ul>
        </div>
        {% else %}
        <a href="{{ url_for('login_get') }}" class="btn text-large nav-btn">Login</a>
        <a href="{{ url_for('register_get') }}" class="btn text-large">Register</a>
        {% endif %}
      </section>
    </header>
    {% block content %}{% endblock %}
  </body>
</html>